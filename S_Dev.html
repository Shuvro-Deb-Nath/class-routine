<!doctype html>
<html>
  <head>
    <title>Dev Control</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="stylesheet" href="style.css" />
    <link rel="stylesheet" href="admin.css" />
    <link rel="icon" href="y.png" type="image/png" sizes="32x32"/> 
    
    
  </head>
  <body>
    <!-- Toast Container -->
    <div id="toastContainer" class="toast-container"></div>
    
    <div class="admin-wrapper">
      <h1 class="admin-title">&gt;_ Dev Control</h1>
      <div class="admin-title-bar"></div>
      <p class="admin-subtitle">CSE 60 A &nbsp;|&nbsp; SPRING 2026 &nbsp;|&nbsp; ADMIN TERMINAL</p>
      
      <!-- ================= TIME SLOT MANAGER (NEW!) ================= -->
      <div class="card" style="border-color: #fbbf24 !important;">
        <h3>‚è∞ Time Slot Manager (Ramadan / Custom Schedule)</h3>
        <p >
          <b>‚ö†Ô∏è Important:</b> Changing time slots will affect the entire routine. 
          Use this to switch between normal and Ramadan schedules.
        </p>

        <div class="info-box" style="border-color:rgba(251,191,36,0.3);">
          <div class="info-box-label" style="color:rgba(251,191,36,0.7);">Current Time Slots</div>
          <div id="currentSlotsList"></div>
        </div>

        <h4 >Add/Edit Time Slot:</h4>
        <select id="slotPosition">
          <option value="0">Slot 1 (First Period)</option>
          <option value="1">Slot 2 (Second Period)</option>
          <option value="2">Slot 3 (Third Period)</option>
          <option value="3">Slot 4 (Break Time)</option>
          <option value="4">Slot 5 (Fourth Period)</option>
          <option value="5">Slot 6 (Fifth Period)</option>
        </select>

        <label >Start Time:</label>
        <input id="slotStartTime" type="time" value="08:45" />

        <label >End Time:</label>
        <input id="slotEndTime" type="time" value="10:05" />

        <button class="btn-orange" onclick="updateTimeSlot()">üíæ Update Time Slot</button>
         <label>‚òï Select Break Slot</label>

<select id="breakSlot">
  
  <option value="3">Slot 4</option>
  <option value="4">Slot 5</option>
</select>

<button class="btn-green" onclick="saveBreakSlot()">
  üíæ Save Break Slot
</button>
        <hr />
        
        <h4 >Quick Presets:</h4>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
          <button class="btn-blue" onclick="loadNormalSchedule()">
            üìÖ Normal Schedule<br>
            <small>(08:45-10:05 format)</small>
          </button>
          <button class="btn-orange" onclick="loadRamadanSchedule()">
            üåô Ramadan Schedule<br>
            <small>(09:00-10:00 format)</small>
          </button>
        </div>
      </div>

      <!-- ================= EFFECTIVE DATE MANAGER ================= -->
      <div class="card" style="border-color: #10b981 !important;">
        <h3>üìÖ Routine Effective Date</h3>
        <p >
          Set the "Effective from" date that appears in the routine header.
        </p>

        <div class="info-box" style="border-color:rgba(16,185,129,0.3);">
          <div class="info-box-label" style="color:rgba(16,185,129,0.7);">Current Effective Date</div>
          <div id="currentEffectiveDate" class="info-box-value">Loading...</div>
        </div>

        <label >New Effective Date:</label>
        <input id="effectiveDate" type="date"  />

        <button class="btn-green" onclick="updateEffectiveDate()">üíæ Update Effective Date</button>
      </div>

      <!-- ================= NOTICE ================= -->
      <div class="card">
        <h3>üì¢ Add Notice</h3>

        <input id="title" placeholder="Title" />
        <textarea id="msg" placeholder="Message"></textarea>

        <button class="btn-blue" onclick="addNotice()">Add Notice</button>
        <hr />
        <h4>Existing Notices</h4>
        <div id="noticeList"></div>
      </div>

      <!-- ================= CANCEL CLASS ================= -->
      <div class="card">
        <h3>‚ùå Cancel Class</h3>

        <!-- Schedule type toggle -->
        <label>üìÖ Which Schedule?</label>
        <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-bottom:4px;">
          <button id="cancelScheduleMain" class="btn-blue" onclick="setCancelSchedule('main')" style="margin:0;">
            üìÖ Main Routine
          </button>
          <button id="cancelScheduleRamadan" class="btn-orange" onclick="setCancelSchedule('ramadan')" style="margin:0; opacity:0.5;">
            üåô Ramadan Routine
          </button>
        </div>

        <!-- Active schedule indicator -->
        <div class="info-box" style="padding:8px 14px; margin-bottom:4px;">
          <span id="cancelScheduleLabel" style="font-family:monospace; font-size:13px; color:#38bdf8;">
            &gt;_ Cancelling from: <b style="color:#00ffff;">MAIN ROUTINE</b>
          </span>
        </div>

        <label>üìÜ Day</label>
        <select id="cday">
          <option value="MON">MON</option>
          <option value="TUE">TUE</option>
          <option value="WED">WED</option>
          <option value="THU">THU</option>
          <option value="FRI">FRI</option>
          <option value="SAT">SAT</option>
          <option value="SUN">SUN</option>
        </select>

        <label>‚è∞ Time Slot</label>
        <select id="ctime"></select>

        <label>üìö Subject</label>
        <input id="csubject" placeholder="Auto-filled from routine" disabled />

        <label>üìÖ Date</label>
        <input id="cdate" type="date" />

        <label>üí¨ Reason</label>
        <input id="creason" placeholder="e.g. Teacher Unavailable" />

        <button id="cancelToggleBtn" onclick="toggleCancel()" class="btn-red">
          Cancel Class
        </button>
      </div>

      <!-- ================= EVENTS ================= -->
      <div class="card">
        <h3>üìò Add Assignment / CT / Exam</h3>

        <input id="etype" placeholder="assignment or exam" />
        <input id="course" placeholder="Course name" />
        <input id="etitle" placeholder="Title" />

        <input id="edate" type="date" />
        <input id="etime" type="time" />

        <button class="btn-orange" onclick="addEvent()">Add Event</button>
        <hr />
        <h4>Existing Events</h4>
        <div id="eventList"></div>
      </div>

      <!-- ================= ROUTINE EDITOR ================= -->
      <div class="card">
        <h3>üõ† Edit Routine</h3>

        <select id="editDay">
          <option value="MON">MON</option>
          <option value="TUE">TUE</option>
          <option value="WED">WED</option>
          <option value="THU">THU</option>
          <option value="FRI">FRI</option>
          <option value="SAT">SAT</option>
          <option value="SUN">SUN</option>
        </select>

        <select id="editTime"></select>

        <input id="editSubject" placeholder="Subject" />
        <input id="editRoom" placeholder="Room" />
        <input id="editCode" placeholder="Code" />

        <button class="btn-green" onclick="updateSlot()">Update Slot</button>
        <button class="btn-blue" onclick="addSlot()">Add Slot</button>
        <button class="btn-red" onclick="deleteSlot()">Delete Slot</button>
      </div>
      
      <!-- ================= EXAM ROUTINE MANAGER ================= -->
      <div class="card" style="border-color: #0ea5e9 !important;">
        <h3>üìù Exam Routine Manager</h3>
        <p >
          <b>üìå Note:</b> Launching the exam routine will <b>replace</b> the main class routine on the main page until you restore it.
        </p>

        <!-- Mode control -->
        <div style="background: rgba(14,165,233,0.15); padding: 15px; border-radius: 10px; margin-bottom: 15px;">
          <h4 style="color: #7dd3fc; margin-top: 0;">Current Mode:</h4>
          <div id="currentExamMode" class="info-box-value">Loading...</div>
        </div>

        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px;">
          <button class="btn-blue" onclick="launchExamRoutine()">üöÄ Launch Exam Routine</button>
          <button class="btn-green" onclick="restoreMainRoutine()">‚Ü©Ô∏è Restore Main Routine</button>
        </div>

        <hr style="border-color: rgba(0,200,255,0.2);" />

        <h4>‚ûï Add Exam Entry</h4>

        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
          <div>
            <label>üìÖ Exam Date</label>
            <input id="examDate" type="date" />
          </div>
          <div>
            <label>‚è∞ Start Time</label>
            <input id="examStartTime" type="time" />
          </div>
          <div>
            <label>‚è∞ End Time</label>
            <input id="examEndTime" type="time" />
          </div>
          <div>
            <label>üè´ Room No</label>
            <input id="examRoom" placeholder="e.g. Room 301" />
          </div>
        </div>

        <label>üìö Course Name</label>
        <input id="examCourseName" placeholder="e.g. Data Structures" />

        <label>üî¢ Course Code</label>
        <input id="examCourseCode" placeholder="e.g. CSE 2105" />

        <button class="btn-cyan" onclick="addExamEntry()">‚ûï Add Exam Entry</button>

        <hr style="border-color: rgba(0,200,255,0.2); margin-top:20px;" />
        <h4>üìã Current Exam Entries</h4>
        <div id="examEntryList"></div>
      </div>

      <hr />
      <h3>üìã Cancelled Classes List</h3>
      <div id="cancelList"></div>
    </div>

    <!-- ================= FIREBASE SCRIPT ================= -->
    <script type="module">
      /* ==========================================
         TOAST NOTIFICATION SYSTEM
      ========================================== */
      window.showToast = function(options) {
        const {
          title = 'Notification',
          message = '',
          type = 'info',
          duration = 3000,
          icon = null
        } = options;
        
        const container = document.getElementById('toastContainer');
        if (!container) return;
        
        const icons = {
          success: '‚úì',
          error: '‚úï',
          warning: '‚ö†',
          info: '‚Ñπ'
        };
        
        const toastIcon = icon || icons[type] || '‚Ñπ';
        
        const toast = document.createElement('div');
        toast.className = `toast ${type}`;
        
        toast.innerHTML = `
          <div class="toast-icon">${toastIcon}</div>
          <div class="toast-content">
            <div class="toast-title">${title}</div>
            ${message ? `<p class="toast-message">${message}</p>` : ''}
          </div>
          <button class="toast-close" onclick="this.parentElement.remove()">√ó</button>
          <div class="toast-progress"></div>
        `;
        
        container.appendChild(toast);
        
        setTimeout(() => {
          toast.classList.add('hiding');
          setTimeout(() => toast.remove(), 400);
        }, duration);
      };
      
      /* ==========================================
         FIREBASE SETUP
      ========================================== */
      import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
      import {
        getFirestore,
        collection,
        addDoc,
        deleteDoc,
        getDocs,
        doc,
        getDoc,
        updateDoc,
        setDoc,
      } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-firestore.js";

      const firebaseConfig = {
        apiKey: "AIzaSyDoJVuE1cZTSRCMKen3DqlInJyZjQFs4UI",
        authDomain: "class-routine-8b46c.firebaseapp.com",
        projectId: "class-routine-8b46c",
        storageBucket: "class-routine-8b46c.firebasestorage.app",
        messagingSenderId: "666402119675",
        appId: "1:666402119675:web:8fdc82c87af8303ed1355e",
      };

      const app = initializeApp(firebaseConfig);
      const db = getFirestore(app);

      /* ================= TIME SLOT MANAGEMENT ================= */
      
      // Convert 24h time to 12h format
      function formatTime12h(time24) {
        const [h, m] = time24.split(':').map(Number);
        const period = h >= 12 ? 'PM' : 'AM';
        const h12 = h === 0 ? 12 : h > 12 ? h - 12 : h;
        return `${String(h12).padStart(2, '0')}:${String(m).padStart(2, '0')} ${period}`;
      }

      // Load and display current time slots
      async function loadCurrentTimeSlots() {
        const list = document.getElementById('currentSlotsList');
        list.innerHTML = '<div >Loading...</div>';

        try {
          const snap = await getDoc(doc(db, "settings", "timeSlots"));
          
          if (snap.exists()) {
            const slots = snap.data().slots || [];
            list.innerHTML = '';
            
            slots.forEach((slot, index) => {
              const div = document.createElement('div');
              div.className = 'exam-entry-card';
              div.innerHTML = `<b>Slot ${index + 1}:</b> ${slot}`;
              list.appendChild(div);
            });
          } else {
            list.innerHTML = '<div style="color: #fbbf24;">‚ö†Ô∏è No time slots configured. Set up default schedule below.</div>';
          }
        } catch (e) {
          list.innerHTML = '<div style="color: #ef4444;">‚ùå Error loading slots</div>';
          console.error(e);
        }
      }

      // Update a single time slot
      window.updateTimeSlot = async function() {
        const position = parseInt(slotPosition.value);
        const startTime = slotStartTime.value;
        const endTime = slotEndTime.value;

        if (!startTime || !endTime) {
          alert('‚ö†Ô∏è Please select both start and end times');
          return;
        }

        // Format to 12h
        const formatted = `${formatTime12h(startTime)} ‚Äì${formatTime12h(endTime)}`;

        try {
          // Get current slots
          const snap = await getDoc(doc(db, "settings", "timeSlots"));
          let slots = snap.exists() ? snap.data().slots : [];

          // Ensure array has enough slots
          while (slots.length <= position) {
            slots.push('');
          }

          // Update specific slot
          slots[position] = formatted;

          // Save back
          await setDoc(doc(db, "settings", "timeSlots"), { slots });

          showToast({
            title: 'Time Slot Updated! ‚è∞',
            message: `Slot ${position + 1}: ${formatted}`,
            type: 'success'
          });
          loadCurrentTimeSlots();
          loadEditTimeDropdown();
          loadCancelSlots();
        } catch (e) {
          alert('‚ùå Error updating time slot');
          console.error(e);
        }
      };

      // Load normal schedule preset
      window.loadNormalSchedule = async function() {
        const slots = [
          "08:45 AM ‚Äì10:05 AM",
          "10:05 AM ‚Äì11:25 AM",
          "11:25 AM ‚Äì12:45 PM",
          "12:45 PM ‚Äì01:15 PM",
          "01:15 PM ‚Äì02:35 PM",
          "02:35 PM ‚Äì03:55 PM"
        ];

        if (!confirm('üîÑ This will replace all current time slots with normal schedule. Continue?')) {
          return;
        }

        try {
          await setDoc(doc(db, "settings", "timeSlots"), { slots });
          showToast({
            title: 'Schedule Updated! üìÖ',
            message: 'Normal schedule has been loaded',
            type: 'success',
            icon: '‚úì'
          });
          loadCurrentTimeSlots();
          loadEditTimeDropdown();
          loadCancelSlots();
        } catch (e) {
          alert('‚ùå Error loading preset');
          console.error(e);
        }
      };

      // Load Ramadan schedule preset
      window.loadRamadanSchedule = async function() {
        const slots = [
          "09:00 AM ‚Äì10:00 AM",
          "10:00 AM ‚Äì11:00 AM",
          "11:00 AM ‚Äì12:00 PM",
          "12:00 PM ‚Äì12:30 PM",
          "12:30 PM ‚Äì01:30 PM",
          "01:30 PM ‚Äì02:30 PM"
        ];

        if (!confirm('üåô This will replace all current time slots with Ramadan schedule. Continue?')) {
          return;
        }

        try {
          await setDoc(doc(db, "settings", "timeSlots"), { slots });
          showToast({
            title: 'Schedule Updated! üåô',
            message: 'Ramadan schedule has been loaded',
            type: 'success',
            icon: '‚úì'
          });
          loadCurrentTimeSlots();
          loadEditTimeDropdown();
          loadCancelSlots();
        } catch (e) {
          alert('‚ùå Error loading preset');
          console.error(e);
        }
      };

      // Load time slots into edit dropdown
      async function loadEditTimeDropdown() {
        const dropdown = document.getElementById('editTime');
        dropdown.innerHTML = '<option>Loading...</option>';

        try {
          const snap = await getDoc(doc(db, "settings", "timeSlots"));
          
          if (snap.exists()) {
            const slots = snap.data().slots || [];
            dropdown.innerHTML = '';
            
            slots.forEach(slot => {
              if (slot) {
                const opt = document.createElement('option');
                opt.value = slot;
                opt.textContent = slot;
                dropdown.appendChild(opt);
              }
            });
          } else {
            dropdown.innerHTML = '<option>No slots configured</option>';
          }
        } catch (e) {
          dropdown.innerHTML = '<option>Error loading slots</option>';
          console.error(e);
        }
      }

      /* ================= NOTICE FUNCTIONS ================= */
      window.addNotice = async function () {
        if (!title.value || !msg.value) {
          alert("‚ö†Ô∏è Please fill in title and message");
          return;
        }

        await addDoc(collection(db, "notices"), {
          title: title.value,
          message: msg.value,
          created: Date.now(),
        });

        showToast({
          title: 'Notice Published! üì¢',
          message: 'All students will see this notice',
          type: 'success'
        });
        title.value = "";
        msg.value = "";
        loadNoticesList();
      };

      async function loadNoticesList() {
        const list = document.getElementById("noticeList");
        list.innerHTML = "";

        const snap = await getDocs(collection(db, "notices"));

        if (snap.empty) {
          list.innerHTML = "<p>No notices</p>";
          return;
        }

        snap.forEach((docSnap) => {
          const n = docSnap.data();

          const div = document.createElement("div");
          div.innerHTML = `
            <b>${n.title}</b>
            <button onclick="deleteNotice('${docSnap.id}')">‚ùå</button>
            <br>
            <small>${n.message}</small>
            <hr>
          `;

          list.appendChild(div);
        });
      }

      window.deleteNotice = async function (id) {
        await deleteDoc(doc(db, "notices", id));
        loadNoticesList();
      };

      /* ================= EVENT FUNCTIONS ================= */
      window.addEvent = async function () {
        if (!etype.value || !course.value || !etitle.value || !edate.value || !etime.value) {
          alert("‚ö†Ô∏è Please fill all fields");
          return;
        }

        await addDoc(collection(db, "events"), {
          type: etype.value.toLowerCase(),
          course: course.value,
          title: etitle.value,
          date: edate.value,
          time: etime.value,
        });

        showToast({
          title: 'Event Added! üìò',
          message: `${etype.value} - ${course.value}`,
          type: 'success'
        });
        etype.value = "";
        course.value = "";
        etitle.value = "";
        edate.value = "";
        etime.value = "";
        loadEventList();
      };

      async function loadEventList() {
        const list = document.getElementById("eventList");
        list.innerHTML = "";

        const snap = await getDocs(collection(db, "events"));

        if (snap.empty) {
          list.innerHTML = "<p>No events</p>";
          return;
        }

        snap.forEach((docSnap) => {
          const e = docSnap.data();

          const div = document.createElement("div");
          div.innerHTML = `
            <b>${e.type.toUpperCase()}</b> - ${e.title}
            <button onclick="deleteEvent('${docSnap.id}')">‚ùå</button>
            <br>
            <small>${e.course} | ${e.date} ${e.time}</small>
            <hr>
          `;

          list.appendChild(div);
        });
      }

      window.deleteEvent = async function (id) {
        await deleteDoc(doc(db, "events", id));
        loadEventList();
      };

      /* ================= CANCEL CLASS TOGGLE ================= */

      // Track which schedule we're cancelling from
      let cancelScheduleMode = "main"; // "main" or "ramadan"

      window.setCancelSchedule = function(mode) {
        cancelScheduleMode = mode;
        const label = document.getElementById("cancelScheduleLabel");
        const mainBtn = document.getElementById("cancelScheduleMain");
        const ramadanBtn = document.getElementById("cancelScheduleRamadan");

        if (mode === "ramadan") {
          label.innerHTML = `&gt;_ Cancelling from: <b style="color:#fb923c;">RAMADAN ROUTINE</b>`;
          mainBtn.style.opacity = "0.5";
          ramadanBtn.style.opacity = "1";
        } else {
          label.innerHTML = `&gt;_ Cancelling from: <b style="color:#00ffff;">MAIN ROUTINE</b>`;
          mainBtn.style.opacity = "1";
          ramadanBtn.style.opacity = "0.5";
        }

        // Reload time slots for the selected schedule
        loadCancelSlots();
      };

      async function findCancelDoc(day, time, date) {
        const snap = await getDocs(collection(db, "cancelled"));
        return snap.docs.find((d) => {
          const c = d.data();
          return c.day === day && c.time === time && c.date === date;
        });
      }

      window.toggleCancel = async function () {
        const day    = cday.value;
        const time   = ctime.value;
        const date   = cdate.value;
        const reason = creason.value || "Cancelled";

        if (!date) {
          showToast({ title: '‚ö†Ô∏è Select a date', type: 'warning' });
          return;
        }

        const found = await findCancelDoc(day, time, date);

        if (found) {
          await deleteDoc(doc(db, "cancelled", found.id));
          showToast({ title: '‚úÖ Cancel Removed', message: `${day} ‚Äî ${time}`, type: 'success' });
        } else {
          await addDoc(collection(db, "cancelled"), {
            day,
            time,
            date,
            reason,
            schedule: cancelScheduleMode  // save which schedule it belongs to
          });
          showToast({ title: '‚ùå Class Cancelled', message: `${day} ‚Äî ${time} | ${reason}`, type: 'warning' });
        }

        updateToggleText();
        loadCancelledList();
      };

      async function updateToggleText() {
        const btn  = document.getElementById("cancelToggleBtn");
        const date = cdate.value;

        if (!date) {
          btn.textContent = "Cancel Class";
          btn.className = "btn-red";
          return;
        }

        const found = await findCancelDoc(cday.value, ctime.value, date);

        if (found) {
          btn.textContent = "‚Ü©Ô∏è Undo Cancel";
          btn.className = "btn-green";
        } else {
          btn.textContent = "‚ùå Cancel Class";
          btn.className = "btn-red";
        }
      }

      ["cday", "ctime", "cdate"].forEach((id) => {
        document.getElementById(id).addEventListener("change", updateToggleText);
      });

      /* ================= CANCELLED CLASSES LIST ================= */
      /* ================= CANCELLED CLASSES LIST ================= */
      async function loadCancelledList() {
        const list = document.getElementById("cancelList");
        list.innerHTML = "";

        const snap = await getDocs(collection(db, "cancelled"));

        if (snap.empty) {
          list.innerHTML = "<p style='color:rgba(0,200,255,0.5);font-family:monospace;'>&gt;_ No cancelled classes</p>";
          return;
        }

        snap.forEach((docSnap) => {
          const c = docSnap.data();
          const scheduleTag = c.schedule === "ramadan"
            ? `<span style="background:rgba(251,146,60,0.2);color:#fb923c;border:1px solid rgba(251,146,60,0.4);border-radius:4px;padding:1px 6px;font-size:11px;margin-left:6px;">üåô RAMADAN</span>`
            : `<span style="background:rgba(56,189,248,0.15);color:#38bdf8;border:1px solid rgba(56,189,248,0.3);border-radius:4px;padding:1px 6px;font-size:11px;margin-left:6px;">üìÖ MAIN</span>`;

          const div = document.createElement("div");
          div.innerHTML = `
            <div style="display:flex; justify-content:space-between; align-items:center; gap:10px; flex-wrap:wrap;">
              <div style="font-family:monospace; line-height:1.7;">
                <span style="color:#f87171; font-weight:bold;">${c.day}</span>
                ${scheduleTag}
                <span style="color:rgba(100,180,255,0.5); margin:0 4px;">|</span>
                <span style="color:#7dd3fc;">${c.time}</span>
                <span style="color:rgba(100,180,255,0.5); margin:0 4px;">|</span>
                <span style="color:#bae6fd;">${c.date}</span>
                <span style="color:rgba(100,180,255,0.5); margin:0 4px;">|</span>
                <span style="color:#fbbf24;">${c.reason}</span>
              </div>
              <button onclick="deleteCancel('${docSnap.id}')" class="btn-red" style="width:auto; padding:5px 12px; font-size:12px; margin:0; flex-shrink:0;">
                ‚úï Delete
              </button>
            </div>
          `;

          list.appendChild(div);
        });
      }

      window.deleteCancel = async function (id) {
        await deleteDoc(doc(db, "cancelled", id));
        loadCancelledList();
      };

      /* ================= ROUTINE SLOT EDITOR ================= */
      document.getElementById("editTime").addEventListener("change", loadSlotDetails);
      document.getElementById("editDay").addEventListener("change", loadEditTimeDropdown);

      async function loadSlotDetails() {
        const day = editDay.value;

        const snap = await getDoc(doc(db, "routine", day));

        if (!snap.exists()) return;

        const classes = snap.data().classes;
        const found = classes.find((c) => c.time === editTime.value);

        if (!found) {
          editSubject.value = "";
          editRoom.value = "";
          editCode.value = "";
          return;
        }

        editSubject.value = found.subject;
        editRoom.value = found.room;
        editCode.value = found.code;
      }

      window.updateSlot = async function () {
        const day = editDay.value;

        const snap = await getDoc(doc(db, "routine", day));

        if (!snap.exists()) {
          alert("‚ùå Day not found");
          return;
        }

        const classes = snap.data().classes;
        const index = classes.findIndex((c) => c.time === editTime.value);

        if (index === -1) {
          alert("‚ùå Slot not found");
          return;
        }

        classes[index] = {
          time: editTime.value,
          subject: editSubject.value,
          room: editRoom.value,
          code: editCode.value,
        };

        await updateDoc(doc(db, "routine", day), {
          classes: classes,
        });

        showToast({
          title: 'Routine Updated! üõ†',
          message: 'Class slot has been updated',
          type: 'success'
        });
      };

      window.addSlot = async function () {
        const day = editDay.value;

        const snap = await getDoc(doc(db, "routine", day));

        if (!snap.exists()) {
          alert("‚ùå Day not found");
          return;
        }

        const classes = snap.data().classes;

        if (classes.find((c) => c.time === editTime.value)) {
          alert("‚ùå Slot already exists");
          return;
        }

        classes.push({
          time: editTime.value,
          subject: editSubject.value,
          room: editRoom.value,
          code: editCode.value,
        });

        await updateDoc(doc(db, "routine", day), {
          classes: classes,
        });

        showToast({
          title: 'Slot Added! ‚ûï',
          message: 'New class has been added to routine',
          type: 'success'
        });
      };

      window.deleteSlot = async function () {
        const day = editDay.value;

        const snap = await getDoc(doc(db, "routine", day));

        if (!snap.exists()) {
          alert("‚ùå Day not found");
          return;
        }

        let classes = snap.data().classes;
        classes = classes.filter((c) => c.time !== editTime.value);

        await updateDoc(doc(db, "routine", day), {
          classes: classes,
        });

        alert("üóë Slot removed");
      };

      /* ================= SMART CANCEL UI ================= */
      document.getElementById("cday").addEventListener("change", loadCancelSlots);

      async function loadCancelSlots() {
        const day = cday.value;

        // Load the routine classes (always from "routine" collection ‚Äî same subjects)
        const snap = await getDoc(doc(db, "routine", day));
        if (!snap.exists()) return;
        const classes = snap.data().classes || [];

        // Load current active time slots (could be normal or Ramadan)
        let activeSlots = [];
        if (cancelScheduleMode === "ramadan") {
          // Load Ramadan slots from Firebase settings
          const slotsSnap = await getDoc(doc(db, "settings", "timeSlots"));
          activeSlots = slotsSnap.exists() ? slotsSnap.data().slots || [] : [];
        } else {
          // Main routine: use the saved times from Firebase routine directly
          activeSlots = classes.map(c => c.time);
        }

        // Remove break slot (empty-ish slot)
        const breakSnap = await getDoc(doc(db, "settings", "break"));
        const bkIndex = breakSnap.exists() ? (breakSnap.data().index ?? 3) : 3;

        ctime.innerHTML = "";

        if (cancelScheduleMode === "ramadan") {
          // Map each Ramadan slot by position to the class at that position
          // Classes in Firebase are sorted by their original time
          const sortedClasses = [...classes].sort((a, b) => {
            const pa = parse12hTimeAdmin(a.time);
            const pb = parse12hTimeAdmin(b.time);
            return (pa.h * 60 + pa.m) - (pb.h * 60 + pb.m);
          });

          activeSlots.forEach((slot, i) => {
            if (i === bkIndex) return; // skip break
            // Map slot index to class (break shifts index)
            const classIndex = i > bkIndex ? i - 1 : i;
            const cls = sortedClasses[classIndex];
            const opt = document.createElement("option");
            opt.value = slot; // save the RAMADAN time string
            opt.dataset.originalTime = cls ? cls.time : ""; // keep original for subject lookup
            opt.textContent = slot + (cls ? ` ‚Äî ${cls.subject}` : "");
            ctime.appendChild(opt);
          });
        } else {
          // Main routine: just show the saved class times
          classes.forEach((c) => {
            const opt = document.createElement("option");
            opt.value = c.time;
            opt.textContent = c.time;
            ctime.appendChild(opt);
          });
        }

        fillCancelSubject();
      }

      document.getElementById("ctime").addEventListener("change", fillCancelSubject);

      async function fillCancelSubject() {
        const day = cday.value;
        const snap = await getDoc(doc(db, "routine", day));
        if (!snap.exists()) return;
        const classes = snap.data().classes || [];

        if (cancelScheduleMode === "ramadan") {
          // Get original time from selected option's dataset
          const selectedOpt = ctime.options[ctime.selectedIndex];
          const originalTime = selectedOpt ? selectedOpt.dataset.originalTime : "";
          const found = classes.find(c => c.time === originalTime);
          csubject.value = found ? found.subject + " (" + found.room + ")" : "";
        } else {
          const found = classes.find((c) => c.time === ctime.value);
          csubject.value = found ? found.subject + " (" + found.room + ")" : "";
        }
      }

      // Helper: parse 12h time in admin context (same logic as script.js)
      function parse12hTimeAdmin(str) {
        if (!str) return { h: 0, m: 0 };
        const parts = str.trim().split("‚Äì")[0].trim().split(" ");
        const [time, mer] = [parts[0], parts[1]];
        let [h, m] = time.split(":").map(Number);
        if (mer === "PM" && h !== 12) h += 12;
        if (mer === "AM" && h === 12) h = 0;
        return { h, m };
      }

      /* ================= EFFECTIVE DATE MANAGER ================= */
      
      // Load current effective date
      async function loadCurrentEffectiveDate() {
        try {
          const snap = await getDoc(doc(db, "settings", "effectiveDate"));
          
          if (snap.exists()) {
            const dateStr = snap.data().date;
            document.getElementById("currentEffectiveDate").textContent = dateStr;
            
            // Pre-fill the input with current date
            const date = new Date(dateStr);
            const formattedDate = date.toISOString().split('T')[0];
            document.getElementById("effectiveDate").value = formattedDate;
          } else {
            document.getElementById("currentEffectiveDate").textContent = "7 FEBRUARY 2026 (Default)";
          }
        } catch (error) {
          console.error("Error loading effective date:", error);
          document.getElementById("currentEffectiveDate").textContent = "Error loading date";
        }
      }
      
      // Update effective date
      window.updateEffectiveDate = async function() {
        const dateInput = document.getElementById("effectiveDate").value;
        
        if (!dateInput) {
          alert("‚ùå Please select a date");
          return;
        }
        
        try {
          // Convert to readable format: "7 FEBRUARY 2026"
          const date = new Date(dateInput);
          const months = ['JANUARY', 'FEBRUARY', 'MARCH', 'APRIL', 'MAY', 'JUNE',
                         'JULY', 'AUGUST', 'SEPTEMBER', 'OCTOBER', 'NOVEMBER', 'DECEMBER'];
          
          const day = date.getDate();
          const month = months[date.getMonth()];
          const year = date.getFullYear();
          
          const formattedDate = `${day} ${month} ${year}`;
          
          // Save to Firebase
          await setDoc(doc(db, "settings", "effectiveDate"), {
            date: formattedDate,
            timestamp: new Date().toISOString()
          });
          
          showToast({
            title: 'Effective Date Updated! üìÖ',
            message: formattedDate,
            type: 'success',
            icon: '‚úì'
          });
          loadCurrentEffectiveDate();
          
        } catch (error) {
          console.error("Error updating effective date:", error);
          alert("‚ùå Error updating date: " + error.message);
        }
      };
       
      window.saveBreakSlot = async function () {
  const breakIndex = parseInt(document.getElementById("breakSlot").value);

  try {
    await setDoc(doc(db, "settings", "break"), {
      index: breakIndex
    });

    showToast({
      title: 'Break Updated ‚òï',
      message: `Break is now Slot ${breakIndex + 1}`,
      type: 'success'
    });

  } catch (e) {
    alert("‚ùå Error saving break slot");
    console.error(e);
  }
};

      /* ================= EXAM ROUTINE MANAGER ================= */

      function formatTime12hFromInput(t) {
        const [h, m] = t.split(':').map(Number);
        const p = h >= 12 ? 'PM' : 'AM';
        const h12 = h === 0 ? 12 : h > 12 ? h - 12 : h;
        return `${String(h12).padStart(2,'0')}:${String(m).padStart(2,'0')} ${p}`;
      }

      function getDayName(dateStr) {
        const days = ['Sunday','Monday','Tuesday','Wednesday','Thursday','Friday','Saturday'];
        const d = new Date(dateStr + 'T00:00:00');
        return days[d.getDay()];
      }

      function formatDisplayDate(dateStr) {
        const months = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
        const d = new Date(dateStr + 'T00:00:00');
        return `${d.getDate()} ${months[d.getMonth()]} ${d.getFullYear()}`;
      }

      async function loadExamMode() {
        try {
          const snap = await getDoc(doc(db, "settings", "examMode"));
          const active = snap.exists() && snap.data().active === true;
          document.getElementById("currentExamMode").innerHTML = active
            ? '<span style="color:#7dd3fc;">üìù EXAM ROUTINE is ACTIVE</span>'
            : '<span style="color:#86efac;">üìÖ MAIN ROUTINE is ACTIVE</span>';
        } catch(e) {
          document.getElementById("currentExamMode").textContent = "Error loading";
        }
      }

      window.launchExamRoutine = async function() {
        const snap = await getDocs(collection(db, "examRoutine"));
        if (snap.empty) {
          alert("‚ö†Ô∏è No exam entries found! Please add exam entries first.");
          return;
        }
        if (!confirm("üöÄ Launch Exam Routine? The main class routine will be replaced on the main page.")) return;
        await setDoc(doc(db, "settings", "examMode"), { active: true, updatedAt: Date.now() });
        showToast({ title: 'Exam Routine Launched! üìù', message: 'Students will now see the exam schedule', type: 'success' });
        loadExamMode();
      };

      window.restoreMainRoutine = async function() {
        if (!confirm("‚Ü©Ô∏è Restore Main Class Routine? Exam routine will be hidden.")) return;
        await setDoc(doc(db, "settings", "examMode"), { active: false, updatedAt: Date.now() });
        showToast({ title: 'Main Routine Restored! üìÖ', message: 'Students will now see the class schedule', type: 'success' });
        loadExamMode();
      };

      window.addExamEntry = async function() {
        const date = document.getElementById("examDate").value;
        const startTime = document.getElementById("examStartTime").value;
        const endTime = document.getElementById("examEndTime").value;
        const room = document.getElementById("examRoom").value.trim();
        const courseName = document.getElementById("examCourseName").value.trim();
        const courseCode = document.getElementById("examCourseCode").value.trim();

        if (!date || !startTime || !endTime || !room || !courseName || !courseCode) {
          alert("‚ö†Ô∏è Please fill in all fields");
          return;
        }

        const timeStr = `${formatTime12hFromInput(startTime)} - ${formatTime12hFromInput(endTime)}`;

        await addDoc(collection(db, "examRoutine"), {
          date,
          displayDate: formatDisplayDate(date),
          day: getDayName(date),
          time: timeStr,
          room,
          courseName,
          courseCode,
          createdAt: Date.now()
        });

        showToast({ title: 'Exam Entry Added! ‚úÖ', message: `${courseName} - ${formatDisplayDate(date)}`, type: 'success' });

        document.getElementById("examDate").value = "";
        document.getElementById("examStartTime").value = "";
        document.getElementById("examEndTime").value = "";
        document.getElementById("examRoom").value = "";
        document.getElementById("examCourseName").value = "";
        document.getElementById("examCourseCode").value = "";

        loadExamEntryList();
      };

      async function loadExamEntryList() {
        const list = document.getElementById("examEntryList");
        list.innerHTML = "<p style='color:#38bdf8; font-family:monospace;'>&gt;_ Loading entries...</p>";

        const snap = await getDocs(collection(db, "examRoutine"));

        if (snap.empty) {
          list.innerHTML = "<p style='color:rgba(0,200,255,0.5); font-family:monospace;'>&gt;_ No exam entries yet. Add one above.</p>";
          return;
        }

        const docs = [];
        snap.forEach(d => docs.push({ id: d.id, ...d.data() }));
        docs.sort((a, b) => a.date.localeCompare(b.date));

        list.innerHTML = "";
        docs.forEach((e, i) => {
          // parse stored time back to HH:MM for input fields
          function parseTimeTo24(tStr) {
            if (!tStr) return "";
            const m = tStr.trim().match(/^(\d{1,2}):(\d{2})\s*(AM|PM)$/i);
            if (!m) return "";
            let h = parseInt(m[1]), min = m[2], period = m[3].toUpperCase();
            if (period === "PM" && h !== 12) h += 12;
            if (period === "AM" && h === 12) h = 0;
            return `${String(h).padStart(2,"0")}:${min}`;
          }
          const [startRaw, endRaw] = (e.time || "").split(" - ");
          const startVal = parseTimeTo24(startRaw);
          const endVal   = parseTimeTo24(endRaw);

          const div = document.createElement("div");
          div.className = "exam-entry-card";
          div.id = `entry-${e.id}`;
          div.innerHTML = `
            <div style="display:flex; justify-content:space-between; align-items:flex-start; gap:10px;">
              <div style="flex:1; min-width:0;">
                <span class="entry-num">#${i+1}</span>
                <span class="entry-date" style="margin-left:8px;">${e.displayDate}</span>
                <span class="entry-day" style="margin-left:6px;">(${e.day})</span>
                <div class="entry-course">üíª ${e.courseName}</div>
                <div class="entry-meta">üî¢ ${e.courseCode} &nbsp;|&nbsp; ‚è∞ ${e.time} &nbsp;|&nbsp; üè´ ${e.room}</div>
              </div>
            </div>
            <div class="entry-actions">
              <button class="btn-cyan" onclick="toggleExamEdit('${e.id}')">‚úèÔ∏è Edit</button>
              <button class="btn-red" onclick="deleteExamEntry('${e.id}')">üóëÔ∏è Delete</button>
            </div>

            <!-- Inline edit form -->
            <div class="exam-inline-edit" id="edit-${e.id}">
              <div style="font-family:monospace; color:#00ffff; font-size:12px; letter-spacing:1px; margin-bottom:12px;">&gt;_ EDIT ENTRY</div>
              <div class="edit-grid">
                <div>
                  <label>üìÖ Exam Date</label>
                  <input type="date" id="edit-date-${e.id}" value="${e.date}" />
                </div>
                <div>
                  <label>üè´ Room No</label>
                  <input type="text" id="edit-room-${e.id}" value="${e.room}" placeholder="e.g. Room 301" />
                </div>
                <div>
                  <label>‚è∞ Start Time</label>
                  <input type="time" id="edit-start-${e.id}" value="${startVal}" />
                </div>
                <div>
                  <label>‚è∞ End Time</label>
                  <input type="time" id="edit-end-${e.id}" value="${endVal}" />
                </div>
              </div>
              <label>üìö Course Name</label>
              <input type="text" id="edit-course-${e.id}" value="${e.courseName}" placeholder="Course Name" />
              <label>üî¢ Course Code</label>
              <input type="text" id="edit-code-${e.id}" value="${e.courseCode}" placeholder="Course Code" />
              <div style="display:grid; grid-template-columns:1fr 1fr; gap:8px; margin-top:8px;">
                <button class="save-btn btn-green" onclick="saveExamEdit('${e.id}')">üíæ Save Changes</button>
                <button class="cancel-btn" onclick="toggleExamEdit('${e.id}')">‚úï Cancel</button>
              </div>
            </div>
          `;
          list.appendChild(div);
        });
      }

      window.toggleExamEdit = function(id) {
        const form = document.getElementById(`edit-${id}`);
        form.classList.toggle("open");
      };

      window.saveExamEdit = async function(id) {
        const date       = document.getElementById(`edit-date-${id}`).value;
        const room       = document.getElementById(`edit-room-${id}`).value.trim();
        const startTime  = document.getElementById(`edit-start-${id}`).value;
        const endTime    = document.getElementById(`edit-end-${id}`).value;
        const courseName = document.getElementById(`edit-course-${id}`).value.trim();
        const courseCode = document.getElementById(`edit-code-${id}`).value.trim();

        if (!date || !room || !startTime || !endTime || !courseName || !courseCode) {
          showToast({ title: '‚ö†Ô∏è Fill all fields', type: 'warning' });
          return;
        }

        const timeStr    = `${formatTime12hFromInput(startTime)} - ${formatTime12hFromInput(endTime)}`;
        const displayDate = formatDisplayDate(date);
        const day        = getDayName(date);

        try {
          await updateDoc(doc(db, "examRoutine", id), {
            date, displayDate, day, time: timeStr, room, courseName, courseCode
          });
          showToast({ title: '‚úÖ Entry Updated!', message: `${courseName} ‚Äî ${displayDate}`, type: 'success' });
          loadExamEntryList();
        } catch(err) {
          showToast({ title: '‚ùå Error updating', message: err.message, type: 'error' });
        }
      };

      window.deleteExamEntry = async function(id) {
        if (!confirm("üóëÔ∏è Delete this exam entry?")) return;
        await deleteDoc(doc(db, "examRoutine", id));
        showToast({ title: 'Entry Deleted üóëÔ∏è', message: 'Exam entry removed', type: 'warning' });
        loadExamEntryList();
      };

      loadExamMode();
      loadExamEntryList();

      // Load on page start
      loadCurrentTimeSlots();
      loadNoticesList();
      loadEventList();
      loadCancelledList();
      loadCancelSlots();
      loadEditTimeDropdown();
      loadCurrentEffectiveDate();
    </script>
  </body>
</html>
