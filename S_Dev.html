<!doctype html>
<html>
  <head>
    <title>Dev Control</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="stylesheet" href="style.css" />
    <link rel="stylesheet" href="admin.css" />
    <link rel="icon" href="y.png" type="image/png" sizes="32x32"/> 
    
    <style>
      /* Toast Notifications for Admin Panel */
      .toast-container {
        position: fixed;
        top: 20px;
        right: 20px;
        z-index: 100000;
        display: flex;
        flex-direction: column;
        gap: 10px;
        pointer-events: none;
      }

      .toast {
        background: white;
        color: #1976d2;
        padding: 16px 20px;
        border-radius: 12px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        display: flex;
        align-items: center;
        gap: 12px;
        min-width: 320px;
        max-width: 450px;
        pointer-events: auto;
        animation: toastSlideIn 0.4s ease;
        position: relative;
        overflow: hidden;
      }

      @keyframes toastSlideIn {
        from {
          opacity: 0;
          transform: translateX(400px);
        }
        to {
          opacity: 1;
          transform: translateX(0);
        }
      }

      .toast.hiding {
        animation: toastSlideOut 0.4s ease forwards;
      }

      @keyframes toastSlideOut {
        to {
          opacity: 0;
          transform: translateX(400px);
        }
      }

      .toast-icon {
        font-size: 28px;
        flex-shrink: 0;
      }

      .toast-content {
        flex: 1;
      }

      .toast-title {
        font-weight: bold;
        margin: 0 0 4px 0;
        font-size: 15px;
      }

      .toast-message {
        margin: 0;
        font-size: 13px;
        opacity: 0.85;
      }

      .toast-close {
        background: none;
        border: none;
        font-size: 22px;
        cursor: pointer;
        color: inherit;
        opacity: 0.6;
        padding: 0;
        width: 28px;
        height: 28px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 50%;
        transition: all 0.2s ease;
      }

      .toast-close:hover {
        opacity: 1;
        background: rgba(0, 0, 0, 0.1);
      }

      .toast.success {
        background: linear-gradient(135deg, #10b981, #059669);
        color: white;
      }

      .toast.error {
        background: linear-gradient(135deg, #ef4444, #dc2626);
        color: white;
      }

      .toast.warning {
        background: linear-gradient(135deg, #f59e0b, #d97706);
        color: white;
      }

      .toast.info {
        background: linear-gradient(135deg, #3b82f6, #2563eb);
        color: white;
      }

      .toast-progress {
        position: absolute;
        bottom: 0;
        left: 0;
        height: 4px;
        background: rgba(255, 255, 255, 0.5);
        animation: toastProgress 3s linear forwards;
      }

      @keyframes toastProgress {
        from { width: 100%; }
        to { width: 0%; }
      }

      @media (max-width: 768px) {
        .toast-container {
          top: 10px;
          right: 10px;
          left: 10px;
        }
        
        .toast {
          min-width: auto;
          max-width: 100%;
        }
      }
    </style>
  </head>
  <body>
    <!-- Toast Container -->
    <div id="toastContainer" class="toast-container"></div>
    
    <div class="admin-wrapper">
      <h1 class="admin-title">‚öô Dev Control Dashboard</h1>
      
      <!-- ================= TIME SLOT MANAGER (NEW!) ================= -->
      <div class="card" style="border: 3px solid #fbbf24;">
        <h3>‚è∞ Time Slot Manager (Ramadan / Custom Schedule)</h3>
        <p style="color: white; margin-bottom: 15px;">
          <b>‚ö†Ô∏è Important:</b> Changing time slots will affect the entire routine. 
          Use this to switch between normal and Ramadan schedules.
        </p>

        <div style="background: rgba(251, 191, 36, 0.2); padding: 15px; border-radius: 10px; margin-bottom: 15px;">
          <h4 style="color: #fbbf24; margin-top: 0;">Current Time Slots:</h4>
          <div id="currentSlotsList"></div>
        </div>

        <h4 style="color: white;">Add/Edit Time Slot:</h4>
        <select id="slotPosition">
          <option value="0">Slot 1 (First Period)</option>
          <option value="1">Slot 2 (Second Period)</option>
          <option value="2">Slot 3 (Third Period)</option>
          <option value="3">Slot 4 (Break Time)</option>
          <option value="4">Slot 5 (Fourth Period)</option>
          <option value="5">Slot 6 (Fifth Period)</option>
        </select>

        <label style="color: white; display: block; margin-top: 10px;">Start Time:</label>
        <input id="slotStartTime" type="time" value="08:45" />

        <label style="color: white; display: block; margin-top: 10px;">End Time:</label>
        <input id="slotEndTime" type="time" value="10:05" />

        <button class="btn-orange" onclick="updateTimeSlot()">üíæ Update Time Slot</button>
         <label style="color: white; display:block; margin-top:10px;">
  Select Break Slot:
</label>

<select id="breakSlot">
  
  <option value="3">Slot 4</option>
  <option value="4">Slot 5</option>
</select>

<button class="btn-green" onclick="saveBreakSlot()">
  üíæ Save Break Slot
</button>
        <hr />
        
        <h4 style="color: white;">Quick Presets:</h4>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
          <button class="btn-blue" onclick="loadNormalSchedule()">
            üìÖ Normal Schedule<br>
            <small>(08:45-10:05 format)</small>
          </button>
          <button class="btn-orange" onclick="loadRamadanSchedule()">
            üåô Ramadan Schedule<br>
            <small>(09:00-10:00 format)</small>
          </button>
        </div>
      </div>

      <!-- ================= EFFECTIVE DATE MANAGER ================= -->
      <div class="card" style="border: 3px solid #10b981;">
        <h3>üìÖ Routine Effective Date</h3>
        <p style="color: white; margin-bottom: 15px;">
          Set the "Effective from" date that appears in the routine header.
        </p>

        <div style="background: rgba(16, 185, 129, 0.2); padding: 15px; border-radius: 10px; margin-bottom: 15px;">
          <h4 style="color: #10b981; margin-top: 0;">Current Effective Date:</h4>
          <div id="currentEffectiveDate" style="color: white; font-size: 18px; font-weight: bold;">
            Loading...
          </div>
        </div>

        <label style="color: white; display: block; margin-bottom: 10px;">New Effective Date:</label>
        <input id="effectiveDate" type="date" style="margin-bottom: 15px;" />

        <button class="btn-green" onclick="updateEffectiveDate()">üíæ Update Effective Date</button>
      </div>

      <!-- ================= NOTICE ================= -->
      <div class="card">
        <h3>üì¢ Add Notice</h3>

        <input id="title" placeholder="Title" />
        <textarea id="msg" placeholder="Message"></textarea>

        <button class="btn-blue" onclick="addNotice()">Add Notice</button>
        <hr />
        <h4>Existing Notices</h4>
        <div id="noticeList"></div>
      </div>

      <!-- ================= CANCEL CLASS ================= -->
      <div class="card">
        <h3>‚ùå Cancel Class</h3>
        
        <select id="cday">
          <option value="MON">MON</option>
          <option value="TUE">TUE</option>
          <option value="WED">WED</option>
          <option value="THU">THU</option>
          <option value="FRI">FRI</option>
          <option value="SAT">SAT</option>
          <option value="SUN">SUN</option>
        </select>

        <select id="ctime"></select>

        <input id="csubject" placeholder="Subject" disabled />

        <input id="cdate" type="date" />

        <input id="creason" placeholder="Reason" />

        <button id="cancelToggleBtn" onclick="toggleCancel()" class="btn-red">
          Cancel Class
        </button>
      </div>

      <!-- ================= EVENTS ================= -->
      <div class="card">
        <h3>üìò Add Assignment / CT / Exam</h3>

        <input id="etype" placeholder="assignment or exam" />
        <input id="course" placeholder="Course name" />
        <input id="etitle" placeholder="Title" />

        <input id="edate" type="date" />
        <input id="etime" type="time" />

        <button class="btn-orange" onclick="addEvent()">Add Event</button>
        <hr />
        <h4>Existing Events</h4>
        <div id="eventList"></div>
      </div>

      <!-- ================= ROUTINE EDITOR ================= -->
      <div class="card">
        <h3>üõ† Edit Routine</h3>

        <select id="editDay">
          <option value="MON">MON</option>
          <option value="TUE">TUE</option>
          <option value="WED">WED</option>
          <option value="THU">THU</option>
          <option value="FRI">FRI</option>
          <option value="SAT">SAT</option>
          <option value="SUN">SUN</option>
        </select>

        <select id="editTime"></select>

        <input id="editSubject" placeholder="Subject" />
        <input id="editRoom" placeholder="Room" />
        <input id="editCode" placeholder="Code" />

        <button class="btn-green" onclick="updateSlot()">Update Slot</button>
        <button class="btn-blue" onclick="addSlot()">Add Slot</button>
        <button class="btn-red" onclick="deleteSlot()">Delete Slot</button>
      </div>
      
      <!-- ================= EXAM ROUTINE MANAGER ================= -->
      <div class="card" style="border: 3px solid #a855f7;">
        <h3>üìù Exam Routine Manager</h3>
        <p style="color: white; margin-bottom: 15px;">
          <b>üìå Note:</b> Launching the exam routine will <b>replace</b> the main class routine on the main page until you restore it.
        </p>

        <!-- Mode control -->
        <div style="background: rgba(168,85,247,0.2); padding: 15px; border-radius: 10px; margin-bottom: 15px;">
          <h4 style="color: #d8b4fe; margin-top: 0;">Current Mode:</h4>
          <div id="currentExamMode" style="color: white; font-size: 18px; font-weight: bold;">Loading...</div>
        </div>

        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px;">
          <button style="background: linear-gradient(135deg,#7c3aed,#a855f7); color:white; border:none; padding:12px; border-radius:10px; cursor:pointer; font-weight:bold;" onclick="launchExamRoutine()">üöÄ Launch Exam Routine</button>
          <button style="background: linear-gradient(135deg,#059669,#10b981); color:white; border:none; padding:12px; border-radius:10px; cursor:pointer; font-weight:bold;" onclick="restoreMainRoutine()">‚Ü©Ô∏è Restore Main Routine</button>
        </div>

        <hr style="border-color: rgba(168,85,247,0.3);" />

        <h4 style="color: #d8b4fe;">‚ûï Add Exam Entry</h4>

        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
          <div>
            <label style="color: white; display:block; margin-bottom:5px; font-size:13px;">Exam Date</label>
            <input id="examDate" type="date" style="width:100%; box-sizing:border-box;" />
          </div>
          <div>
            <label style="color: white; display:block; margin-bottom:5px; font-size:13px;">Start Time</label>
            <input id="examStartTime" type="time" style="width:100%; box-sizing:border-box;" />
          </div>
          <div>
            <label style="color: white; display:block; margin-bottom:5px; font-size:13px;">End Time</label>
            <input id="examEndTime" type="time" style="width:100%; box-sizing:border-box;" />
          </div>
          <div>
            <label style="color: white; display:block; margin-bottom:5px; font-size:13px;">Room No</label>
            <input id="examRoom" placeholder="e.g. Room 301" style="width:100%; box-sizing:border-box;" />
          </div>
        </div>

        <label style="color: white; display:block; margin-top:10px; margin-bottom:5px; font-size:13px;">Course Name</label>
        <input id="examCourseName" placeholder="e.g. Data Structures" style="width:100%; box-sizing:border-box;" />

        <label style="color: white; display:block; margin-top:10px; margin-bottom:5px; font-size:13px;">Course Code</label>
        <input id="examCourseCode" placeholder="e.g. CSE 2105" style="width:100%; box-sizing:border-box;" />

        <button style="background: linear-gradient(135deg,#a855f7,#7c3aed); color:white; border:none; padding:12px 20px; border-radius:10px; cursor:pointer; font-weight:bold; margin-top:15px; width:100%;" onclick="addExamEntry()">‚ûï Add Exam Entry</button>

        <hr style="border-color: rgba(168,85,247,0.3); margin-top:20px;" />
        <h4 style="color: #d8b4fe;">üìã Current Exam Entries</h4>
        <div id="examEntryList"></div>
      </div>

      <hr />
      <h3>üìã Cancelled Classes List</h3>
      <div id="cancelList"></div>
    </div>

    <!-- ================= FIREBASE SCRIPT ================= -->
    <script type="module">
      /* ==========================================
         TOAST NOTIFICATION SYSTEM
      ========================================== */
      window.showToast = function(options) {
        const {
          title = 'Notification',
          message = '',
          type = 'info',
          duration = 3000,
          icon = null
        } = options;
        
        const container = document.getElementById('toastContainer');
        if (!container) return;
        
        const icons = {
          success: '‚úì',
          error: '‚úï',
          warning: '‚ö†',
          info: '‚Ñπ'
        };
        
        const toastIcon = icon || icons[type] || '‚Ñπ';
        
        const toast = document.createElement('div');
        toast.className = `toast ${type}`;
        
        toast.innerHTML = `
          <div class="toast-icon">${toastIcon}</div>
          <div class="toast-content">
            <div class="toast-title">${title}</div>
            ${message ? `<p class="toast-message">${message}</p>` : ''}
          </div>
          <button class="toast-close" onclick="this.parentElement.remove()">√ó</button>
          <div class="toast-progress"></div>
        `;
        
        container.appendChild(toast);
        
        setTimeout(() => {
          toast.classList.add('hiding');
          setTimeout(() => toast.remove(), 400);
        }, duration);
      };
      
      /* ==========================================
         FIREBASE SETUP
      ========================================== */
      import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
      import {
        getFirestore,
        collection,
        addDoc,
        deleteDoc,
        getDocs,
        doc,
        getDoc,
        updateDoc,
        setDoc,
      } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-firestore.js";

      const firebaseConfig = {
        apiKey: "AIzaSyDoJVuE1cZTSRCMKen3DqlInJyZjQFs4UI",
        authDomain: "class-routine-8b46c.firebaseapp.com",
        projectId: "class-routine-8b46c",
        storageBucket: "class-routine-8b46c.firebasestorage.app",
        messagingSenderId: "666402119675",
        appId: "1:666402119675:web:8fdc82c87af8303ed1355e",
      };

      const app = initializeApp(firebaseConfig);
      const db = getFirestore(app);

      /* ================= TIME SLOT MANAGEMENT ================= */
      
      // Convert 24h time to 12h format
      function formatTime12h(time24) {
        const [h, m] = time24.split(':').map(Number);
        const period = h >= 12 ? 'PM' : 'AM';
        const h12 = h === 0 ? 12 : h > 12 ? h - 12 : h;
        return `${String(h12).padStart(2, '0')}:${String(m).padStart(2, '0')} ${period}`;
      }

      // Load and display current time slots
      async function loadCurrentTimeSlots() {
        const list = document.getElementById('currentSlotsList');
        list.innerHTML = '<div style="color: white;">Loading...</div>';

        try {
          const snap = await getDoc(doc(db, "settings", "timeSlots"));
          
          if (snap.exists()) {
            const slots = snap.data().slots || [];
            list.innerHTML = '';
            
            slots.forEach((slot, index) => {
              const div = document.createElement('div');
              div.style = 'background: rgba(255,255,255,0.1); padding: 8px; margin: 5px 0; border-radius: 6px; color: white;';
              div.innerHTML = `<b>Slot ${index + 1}:</b> ${slot}`;
              list.appendChild(div);
            });
          } else {
            list.innerHTML = '<div style="color: #fbbf24;">‚ö†Ô∏è No time slots configured. Set up default schedule below.</div>';
          }
        } catch (e) {
          list.innerHTML = '<div style="color: #ef4444;">‚ùå Error loading slots</div>';
          console.error(e);
        }
      }

      // Update a single time slot
      window.updateTimeSlot = async function() {
        const position = parseInt(slotPosition.value);
        const startTime = slotStartTime.value;
        const endTime = slotEndTime.value;

        if (!startTime || !endTime) {
          alert('‚ö†Ô∏è Please select both start and end times');
          return;
        }

        // Format to 12h
        const formatted = `${formatTime12h(startTime)} ‚Äì${formatTime12h(endTime)}`;

        try {
          // Get current slots
          const snap = await getDoc(doc(db, "settings", "timeSlots"));
          let slots = snap.exists() ? snap.data().slots : [];

          // Ensure array has enough slots
          while (slots.length <= position) {
            slots.push('');
          }

          // Update specific slot
          slots[position] = formatted;

          // Save back
          await setDoc(doc(db, "settings", "timeSlots"), { slots });

          showToast({
            title: 'Time Slot Updated! ‚è∞',
            message: `Slot ${position + 1}: ${formatted}`,
            type: 'success'
          });
          loadCurrentTimeSlots();
          loadEditTimeDropdown();
          loadCancelSlots();
        } catch (e) {
          alert('‚ùå Error updating time slot');
          console.error(e);
        }
      };

      // Load normal schedule preset
      window.loadNormalSchedule = async function() {
        const slots = [
          "08:45 AM ‚Äì10:05 AM",
          "10:05 AM ‚Äì11:25 AM",
          "11:25 AM ‚Äì12:45 PM",
          "12:45 PM ‚Äì01:15 PM",
          "01:15 PM ‚Äì02:35 PM",
          "02:35 PM ‚Äì03:55 PM"
        ];

        if (!confirm('üîÑ This will replace all current time slots with normal schedule. Continue?')) {
          return;
        }

        try {
          await setDoc(doc(db, "settings", "timeSlots"), { slots });
          showToast({
            title: 'Schedule Updated! üìÖ',
            message: 'Normal schedule has been loaded',
            type: 'success',
            icon: '‚úì'
          });
          loadCurrentTimeSlots();
          loadEditTimeDropdown();
          loadCancelSlots();
        } catch (e) {
          alert('‚ùå Error loading preset');
          console.error(e);
        }
      };

      // Load Ramadan schedule preset
      window.loadRamadanSchedule = async function() {
        const slots = [
          "09:00 AM ‚Äì10:00 AM",
          "10:00 AM ‚Äì11:00 AM",
          "11:00 AM ‚Äì12:00 PM",
          "12:00 PM ‚Äì12:30 PM",
          "12:30 PM ‚Äì01:30 PM",
          "01:30 PM ‚Äì02:30 PM"
        ];

        if (!confirm('üåô This will replace all current time slots with Ramadan schedule. Continue?')) {
          return;
        }

        try {
          await setDoc(doc(db, "settings", "timeSlots"), { slots });
          showToast({
            title: 'Schedule Updated! üåô',
            message: 'Ramadan schedule has been loaded',
            type: 'success',
            icon: '‚úì'
          });
          loadCurrentTimeSlots();
          loadEditTimeDropdown();
          loadCancelSlots();
        } catch (e) {
          alert('‚ùå Error loading preset');
          console.error(e);
        }
      };

      // Load time slots into edit dropdown
      async function loadEditTimeDropdown() {
        const dropdown = document.getElementById('editTime');
        dropdown.innerHTML = '<option>Loading...</option>';

        try {
          const snap = await getDoc(doc(db, "settings", "timeSlots"));
          
          if (snap.exists()) {
            const slots = snap.data().slots || [];
            dropdown.innerHTML = '';
            
            slots.forEach(slot => {
              if (slot) {
                const opt = document.createElement('option');
                opt.value = slot;
                opt.textContent = slot;
                dropdown.appendChild(opt);
              }
            });
          } else {
            dropdown.innerHTML = '<option>No slots configured</option>';
          }
        } catch (e) {
          dropdown.innerHTML = '<option>Error loading slots</option>';
          console.error(e);
        }
      }

      /* ================= NOTICE FUNCTIONS ================= */
      window.addNotice = async function () {
        if (!title.value || !msg.value) {
          alert("‚ö†Ô∏è Please fill in title and message");
          return;
        }

        await addDoc(collection(db, "notices"), {
          title: title.value,
          message: msg.value,
          created: Date.now(),
        });

        showToast({
          title: 'Notice Published! üì¢',
          message: 'All students will see this notice',
          type: 'success'
        });
        title.value = "";
        msg.value = "";
        loadNoticesList();
      };

      async function loadNoticesList() {
        const list = document.getElementById("noticeList");
        list.innerHTML = "";

        const snap = await getDocs(collection(db, "notices"));

        if (snap.empty) {
          list.innerHTML = "<p>No notices</p>";
          return;
        }

        snap.forEach((docSnap) => {
          const n = docSnap.data();

          const div = document.createElement("div");
          div.innerHTML = `
            <b>${n.title}</b>
            <button onclick="deleteNotice('${docSnap.id}')">‚ùå</button>
            <br>
            <small>${n.message}</small>
            <hr>
          `;

          list.appendChild(div);
        });
      }

      window.deleteNotice = async function (id) {
        await deleteDoc(doc(db, "notices", id));
        loadNoticesList();
      };

      /* ================= EVENT FUNCTIONS ================= */
      window.addEvent = async function () {
        if (!etype.value || !course.value || !etitle.value || !edate.value || !etime.value) {
          alert("‚ö†Ô∏è Please fill all fields");
          return;
        }

        await addDoc(collection(db, "events"), {
          type: etype.value.toLowerCase(),
          course: course.value,
          title: etitle.value,
          date: edate.value,
          time: etime.value,
        });

        showToast({
          title: 'Event Added! üìò',
          message: `${etype.value} - ${course.value}`,
          type: 'success'
        });
        etype.value = "";
        course.value = "";
        etitle.value = "";
        edate.value = "";
        etime.value = "";
        loadEventList();
      };

      async function loadEventList() {
        const list = document.getElementById("eventList");
        list.innerHTML = "";

        const snap = await getDocs(collection(db, "events"));

        if (snap.empty) {
          list.innerHTML = "<p>No events</p>";
          return;
        }

        snap.forEach((docSnap) => {
          const e = docSnap.data();

          const div = document.createElement("div");
          div.innerHTML = `
            <b>${e.type.toUpperCase()}</b> - ${e.title}
            <button onclick="deleteEvent('${docSnap.id}')">‚ùå</button>
            <br>
            <small>${e.course} | ${e.date} ${e.time}</small>
            <hr>
          `;

          list.appendChild(div);
        });
      }

      window.deleteEvent = async function (id) {
        await deleteDoc(doc(db, "events", id));
        loadEventList();
      };

      /* ================= CANCEL CLASS TOGGLE ================= */
      async function findCancelDoc(day, time, date) {
        const snap = await getDocs(collection(db, "cancelled"));

        return snap.docs.find((d) => {
          const c = d.data();
          return c.day === day && c.time === time && c.date === date;
        });
      }

      window.toggleCancel = async function () {
        const day = cday.value;
        const time = ctime.value;
        const date = cdate.value;
        const reason = creason.value || "Cancelled";

        if (!date) {
          alert("‚ö†Ô∏è Please select a date");
          return;
        }

        const found = await findCancelDoc(day, time, date);

        if (found) {
          await deleteDoc(doc(db, "cancelled", found.id));
          alert("‚úÖ Cancel removed");
        } else {
          await addDoc(collection(db, "cancelled"), {
            day,
            time,
            date,
            reason,
          });
          alert("‚ùå Class cancelled");
        }

        updateToggleText();
        loadCancelledList();
      };

      async function updateToggleText() {
        const btn = document.getElementById("cancelToggleBtn");
        const date = cdate.value;

        if (!date) {
          btn.textContent = "Cancel Class";
          btn.className = "btn-red";
          return;
        }

        const found = await findCancelDoc(cday.value, ctime.value, date);

        if (found) {
          btn.textContent = "Undo Cancel";
          btn.className = "btn-green";
        } else {
          btn.textContent = "Cancel Class";
          btn.className = "btn-red";
        }
      }

      ["cday", "ctime", "cdate"].forEach((id) => {
        document.getElementById(id).addEventListener("change", updateToggleText);
      });

      /* ================= CANCELLED CLASSES LIST ================= */
      async function loadCancelledList() {
        const list = document.getElementById("cancelList");
        list.innerHTML = "";

        const snap = await getDocs(collection(db, "cancelled"));

        if (snap.empty) {
          list.innerHTML = "<p>No cancelled classes</p>";
          return;
        }

        snap.forEach((docSnap) => {
          const c = docSnap.data();

          const div = document.createElement("div");
          div.style = `
            background:#f1f5f9;
            padding:8px;
            margin:6px 0;
            border-radius:8px;
          `;

          div.innerHTML = `
            <b>${c.day}</b> |
            ${c.time} |
            ${c.date} |
            ${c.reason}

            <button onclick="deleteCancel('${docSnap.id}')" style="float:right;background:#dc2626;color:white;border:none;border-radius:6px;padding:4px 8px">
              ‚ùå Delete
            </button>
          `;

          list.appendChild(div);
        });
      }

      window.deleteCancel = async function (id) {
        await deleteDoc(doc(db, "cancelled", id));
        loadCancelledList();
      };

      /* ================= ROUTINE SLOT EDITOR ================= */
      document.getElementById("editTime").addEventListener("change", loadSlotDetails);
      document.getElementById("editDay").addEventListener("change", loadEditTimeDropdown);

      async function loadSlotDetails() {
        const day = editDay.value;

        const snap = await getDoc(doc(db, "routine", day));

        if (!snap.exists()) return;

        const classes = snap.data().classes;
        const found = classes.find((c) => c.time === editTime.value);

        if (!found) {
          editSubject.value = "";
          editRoom.value = "";
          editCode.value = "";
          return;
        }

        editSubject.value = found.subject;
        editRoom.value = found.room;
        editCode.value = found.code;
      }

      window.updateSlot = async function () {
        const day = editDay.value;

        const snap = await getDoc(doc(db, "routine", day));

        if (!snap.exists()) {
          alert("‚ùå Day not found");
          return;
        }

        const classes = snap.data().classes;
        const index = classes.findIndex((c) => c.time === editTime.value);

        if (index === -1) {
          alert("‚ùå Slot not found");
          return;
        }

        classes[index] = {
          time: editTime.value,
          subject: editSubject.value,
          room: editRoom.value,
          code: editCode.value,
        };

        await updateDoc(doc(db, "routine", day), {
          classes: classes,
        });

        showToast({
          title: 'Routine Updated! üõ†',
          message: 'Class slot has been updated',
          type: 'success'
        });
      };

      window.addSlot = async function () {
        const day = editDay.value;

        const snap = await getDoc(doc(db, "routine", day));

        if (!snap.exists()) {
          alert("‚ùå Day not found");
          return;
        }

        const classes = snap.data().classes;

        if (classes.find((c) => c.time === editTime.value)) {
          alert("‚ùå Slot already exists");
          return;
        }

        classes.push({
          time: editTime.value,
          subject: editSubject.value,
          room: editRoom.value,
          code: editCode.value,
        });

        await updateDoc(doc(db, "routine", day), {
          classes: classes,
        });

        showToast({
          title: 'Slot Added! ‚ûï',
          message: 'New class has been added to routine',
          type: 'success'
        });
      };

      window.deleteSlot = async function () {
        const day = editDay.value;

        const snap = await getDoc(doc(db, "routine", day));

        if (!snap.exists()) {
          alert("‚ùå Day not found");
          return;
        }

        let classes = snap.data().classes;
        classes = classes.filter((c) => c.time !== editTime.value);

        await updateDoc(doc(db, "routine", day), {
          classes: classes,
        });

        alert("üóë Slot removed");
      };

      /* ================= SMART CANCEL UI ================= */
      document.getElementById("cday").addEventListener("change", loadCancelSlots);

      async function loadCancelSlots() {
        const day = cday.value;

        const snap = await getDoc(doc(db, "routine", day));

        if (!snap.exists()) return;

        const classes = snap.data().classes;

        ctime.innerHTML = "";

        classes.forEach((c) => {
          const opt = document.createElement("option");
          opt.value = c.time;
          opt.textContent = c.time;
          ctime.appendChild(opt);
        });

        fillCancelSubject();
      }

      document.getElementById("ctime").addEventListener("change", fillCancelSubject);

      async function fillCancelSubject() {
        const day = cday.value;

        const snap = await getDoc(doc(db, "routine", day));

        if (!snap.exists()) return;

        const classes = snap.data().classes;
        const found = classes.find((c) => c.time === ctime.value);

        if (found) {
          csubject.value = found.subject + " (" + found.room + ")";
        }
      }

      /* ================= EFFECTIVE DATE MANAGER ================= */
      
      // Load current effective date
      async function loadCurrentEffectiveDate() {
        try {
          const snap = await getDoc(doc(db, "settings", "effectiveDate"));
          
          if (snap.exists()) {
            const dateStr = snap.data().date;
            document.getElementById("currentEffectiveDate").textContent = dateStr;
            
            // Pre-fill the input with current date
            const date = new Date(dateStr);
            const formattedDate = date.toISOString().split('T')[0];
            document.getElementById("effectiveDate").value = formattedDate;
          } else {
            document.getElementById("currentEffectiveDate").textContent = "7 FEBRUARY 2026 (Default)";
          }
        } catch (error) {
          console.error("Error loading effective date:", error);
          document.getElementById("currentEffectiveDate").textContent = "Error loading date";
        }
      }
      
      // Update effective date
      window.updateEffectiveDate = async function() {
        const dateInput = document.getElementById("effectiveDate").value;
        
        if (!dateInput) {
          alert("‚ùå Please select a date");
          return;
        }
        
        try {
          // Convert to readable format: "7 FEBRUARY 2026"
          const date = new Date(dateInput);
          const months = ['JANUARY', 'FEBRUARY', 'MARCH', 'APRIL', 'MAY', 'JUNE',
                         'JULY', 'AUGUST', 'SEPTEMBER', 'OCTOBER', 'NOVEMBER', 'DECEMBER'];
          
          const day = date.getDate();
          const month = months[date.getMonth()];
          const year = date.getFullYear();
          
          const formattedDate = `${day} ${month} ${year}`;
          
          // Save to Firebase
          await setDoc(doc(db, "settings", "effectiveDate"), {
            date: formattedDate,
            timestamp: new Date().toISOString()
          });
          
          showToast({
            title: 'Effective Date Updated! üìÖ',
            message: formattedDate,
            type: 'success',
            icon: '‚úì'
          });
          loadCurrentEffectiveDate();
          
        } catch (error) {
          console.error("Error updating effective date:", error);
          alert("‚ùå Error updating date: " + error.message);
        }
      };
       
      window.saveBreakSlot = async function () {
  const breakIndex = parseInt(document.getElementById("breakSlot").value);

  try {
    await setDoc(doc(db, "settings", "break"), {
      index: breakIndex
    });

    showToast({
      title: 'Break Updated ‚òï',
      message: `Break is now Slot ${breakIndex + 1}`,
      type: 'success'
    });

  } catch (e) {
    alert("‚ùå Error saving break slot");
    console.error(e);
  }
};

      /* ================= EXAM ROUTINE MANAGER ================= */

      function formatTime12hFromInput(t) {
        const [h, m] = t.split(':').map(Number);
        const p = h >= 12 ? 'PM' : 'AM';
        const h12 = h === 0 ? 12 : h > 12 ? h - 12 : h;
        return `${String(h12).padStart(2,'0')}:${String(m).padStart(2,'0')} ${p}`;
      }

      function getDayName(dateStr) {
        const days = ['Sunday','Monday','Tuesday','Wednesday','Thursday','Friday','Saturday'];
        const d = new Date(dateStr + 'T00:00:00');
        return days[d.getDay()];
      }

      function formatDisplayDate(dateStr) {
        const months = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
        const d = new Date(dateStr + 'T00:00:00');
        return `${d.getDate()} ${months[d.getMonth()]} ${d.getFullYear()}`;
      }

      async function loadExamMode() {
        try {
          const snap = await getDoc(doc(db, "settings", "examMode"));
          const active = snap.exists() && snap.data().active === true;
          document.getElementById("currentExamMode").innerHTML = active
            ? '<span style="color:#d8b4fe;">üìù EXAM ROUTINE is ACTIVE</span>'
            : '<span style="color:#86efac;">üìÖ MAIN ROUTINE is ACTIVE</span>';
        } catch(e) {
          document.getElementById("currentExamMode").textContent = "Error loading";
        }
      }

      window.launchExamRoutine = async function() {
        const snap = await getDocs(collection(db, "examRoutine"));
        if (snap.empty) {
          alert("‚ö†Ô∏è No exam entries found! Please add exam entries first.");
          return;
        }
        if (!confirm("üöÄ Launch Exam Routine? The main class routine will be replaced on the main page.")) return;
        await setDoc(doc(db, "settings", "examMode"), { active: true, updatedAt: Date.now() });
        showToast({ title: 'Exam Routine Launched! üìù', message: 'Students will now see the exam schedule', type: 'success' });
        loadExamMode();
      };

      window.restoreMainRoutine = async function() {
        if (!confirm("‚Ü©Ô∏è Restore Main Class Routine? Exam routine will be hidden.")) return;
        await setDoc(doc(db, "settings", "examMode"), { active: false, updatedAt: Date.now() });
        showToast({ title: 'Main Routine Restored! üìÖ', message: 'Students will now see the class schedule', type: 'success' });
        loadExamMode();
      };

      window.addExamEntry = async function() {
        const date = document.getElementById("examDate").value;
        const startTime = document.getElementById("examStartTime").value;
        const endTime = document.getElementById("examEndTime").value;
        const room = document.getElementById("examRoom").value.trim();
        const courseName = document.getElementById("examCourseName").value.trim();
        const courseCode = document.getElementById("examCourseCode").value.trim();

        if (!date || !startTime || !endTime || !room || !courseName || !courseCode) {
          alert("‚ö†Ô∏è Please fill in all fields");
          return;
        }

        const timeStr = `${formatTime12hFromInput(startTime)} - ${formatTime12hFromInput(endTime)}`;

        await addDoc(collection(db, "examRoutine"), {
          date,
          displayDate: formatDisplayDate(date),
          day: getDayName(date),
          time: timeStr,
          room,
          courseName,
          courseCode,
          createdAt: Date.now()
        });

        showToast({ title: 'Exam Entry Added! ‚úÖ', message: `${courseName} - ${formatDisplayDate(date)}`, type: 'success' });

        document.getElementById("examDate").value = "";
        document.getElementById("examStartTime").value = "";
        document.getElementById("examEndTime").value = "";
        document.getElementById("examRoom").value = "";
        document.getElementById("examCourseName").value = "";
        document.getElementById("examCourseCode").value = "";

        loadExamEntryList();
      };

      async function loadExamEntryList() {
        const list = document.getElementById("examEntryList");
        list.innerHTML = "<p style='color:white;'>Loading...</p>";

        const snap = await getDocs(collection(db, "examRoutine"));

        if (snap.empty) {
          list.innerHTML = "<p style='color:#d8b4fe;'>No exam entries yet.</p>";
          return;
        }

        // Sort by date
        const docs = [];
        snap.forEach(d => docs.push({ id: d.id, ...d.data() }));
        docs.sort((a, b) => a.date.localeCompare(b.date));

        list.innerHTML = "";
        docs.forEach((e, i) => {
          const div = document.createElement("div");
          div.style = "background:rgba(168,85,247,0.15); border:1px solid rgba(168,85,247,0.4); padding:12px; margin:8px 0; border-radius:10px;";
          div.innerHTML = `
            <div style="display:flex; justify-content:space-between; align-items:start;">
              <div>
                <b style="color:#d8b4fe;">#${i+1} ‚Äî ${e.displayDate}</b>
                <span style="color:#a78bfa; font-size:12px; margin-left:8px;">(${e.day})</span><br>
                <span style="color:white; font-size:14px;">üìö ${e.courseName}</span><br>
                <span style="color:#c4b5fd; font-size:13px;">üî¢ ${e.courseCode} &nbsp;|&nbsp; ‚è∞ ${e.time} &nbsp;|&nbsp; üè´ ${e.room}</span>
              </div>
              <button onclick="deleteExamEntry('${e.id}')" style="background:#dc2626;color:white;border:none;border-radius:6px;padding:5px 10px;cursor:pointer;flex-shrink:0;">‚ùå</button>
            </div>
          `;
          list.appendChild(div);
        });
      }

      window.deleteExamEntry = async function(id) {
        if (!confirm("Delete this exam entry?")) return;
        await deleteDoc(doc(db, "examRoutine", id));
        showToast({ title: 'Entry Deleted', message: 'Exam entry removed', type: 'warning' });
        loadExamEntryList();
      };

      loadExamMode();
      loadExamEntryList();

      // Load on page start
      loadCurrentTimeSlots();
      loadNoticesList();
      loadEventList();
      loadCancelledList();
      loadCancelSlots();
      loadEditTimeDropdown();
      loadCurrentEffectiveDate();
    </script>
  </body>
</html>
