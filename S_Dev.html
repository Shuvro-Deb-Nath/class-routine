<!doctype html>
<html>
  <head>
    <title>Dev Control</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="stylesheet" href="style.css" />
    <link rel="stylesheet" href="admin.css" />
    <link rel="icon" href="y.png" type="image/png" sizes="32x32"/> 
  </head>
  <body>
    <div class="admin-wrapper">
      <h1 class="admin-title">‚öô Dev Control Dashboard</h1>
      
      <!-- ================= TIME SLOT MANAGER (NEW!) ================= -->
      <div class="card" style="border: 3px solid #fbbf24;">
        <h3>‚è∞ Time Slot Manager (Ramadan / Custom Schedule)</h3>
        <p style="color: white; margin-bottom: 15px;">
          <b>‚ö†Ô∏è Important:</b> Changing time slots will affect the entire routine. 
          Use this to switch between normal and Ramadan schedules.
        </p>

        <div style="background: rgba(251, 191, 36, 0.2); padding: 15px; border-radius: 10px; margin-bottom: 15px;">
          <h4 style="color: #fbbf24; margin-top: 0;">Current Time Slots:</h4>
          <div id="currentSlotsList"></div>
        </div>

        <h4 style="color: white;">Add/Edit Time Slot:</h4>
        <select id="slotPosition">
          <option value="0">Slot 1 (First Period)</option>
          <option value="1">Slot 2 (Second Period)</option>
          <option value="2">Slot 3 (Third Period)</option>
          <option value="3">Slot 4 (Break Time)</option>
          <option value="4">Slot 5 (Fourth Period)</option>
          <option value="5">Slot 6 (Fifth Period)</option>
        </select>

        <label style="color: white; display: block; margin-top: 10px;">Start Time:</label>
        <input id="slotStartTime" type="time" value="08:45" />

        <label style="color: white; display: block; margin-top: 10px;">End Time:</label>
        <input id="slotEndTime" type="time" value="10:05" />

        <button class="btn-orange" onclick="updateTimeSlot()">üíæ Update Time Slot</button>
        
        <hr />
        
        <h4 style="color: white;">Quick Presets:</h4>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
          <button class="btn-blue" onclick="loadNormalSchedule()">
            üìÖ Normal Schedule<br>
            <small>(08:45-10:05 format)</small>
          </button>
          <button class="btn-orange" onclick="loadRamadanSchedule()">
            üåô Ramadan Schedule<br>
            <small>(09:00-10:00 format)</small>
          </button>
        </div>
      </div>

      <!-- ================= EFFECTIVE DATE MANAGER ================= -->
      <div class="card" style="border: 3px solid #10b981;">
        <h3>üìÖ Routine Effective Date</h3>
        <p style="color: white; margin-bottom: 15px;">
          Set the "Effective from" date that appears in the routine header.
        </p>

        <div style="background: rgba(16, 185, 129, 0.2); padding: 15px; border-radius: 10px; margin-bottom: 15px;">
          <h4 style="color: #10b981; margin-top: 0;">Current Effective Date:</h4>
          <div id="currentEffectiveDate" style="color: white; font-size: 18px; font-weight: bold;">
            Loading...
          </div>
        </div>

        <label style="color: white; display: block; margin-bottom: 10px;">New Effective Date:</label>
        <input id="effectiveDate" type="date" style="margin-bottom: 15px;" />

        <button class="btn-green" onclick="updateEffectiveDate()">üíæ Update Effective Date</button>
      </div>

      <!-- ================= NOTICE ================= -->
      <div class="card">
        <h3>üì¢ Add Notice</h3>

        <input id="title" placeholder="Title" />
        <textarea id="msg" placeholder="Message"></textarea>

        <button class="btn-blue" onclick="addNotice()">Add Notice</button>
        <hr />
        <h4>Existing Notices</h4>
        <div id="noticeList"></div>
      </div>

      <!-- ================= CANCEL CLASS ================= -->
      <div class="card">
        <h3>‚ùå Cancel Class</h3>
        
        <select id="cday">
          <option value="MON">MON</option>
          <option value="TUE">TUE</option>
          <option value="WED">WED</option>
          <option value="THU">THU</option>
          <option value="FRI">FRI</option>
          <option value="SAT">SAT</option>
          <option value="SUN">SUN</option>
        </select>

        <select id="ctime"></select>

        <input id="csubject" placeholder="Subject" disabled />

        <input id="cdate" type="date" />

        <input id="creason" placeholder="Reason" />

        <button id="cancelToggleBtn" onclick="toggleCancel()" class="btn-red">
          Cancel Class
        </button>
      </div>

      <!-- ================= EVENTS ================= -->
      <div class="card">
        <h3>üìò Add Assignment / CT / Exam</h3>

        <input id="etype" placeholder="assignment or exam" />
        <input id="course" placeholder="Course name" />
        <input id="etitle" placeholder="Title" />

        <input id="edate" type="date" />
        <input id="etime" type="time" />

        <button class="btn-orange" onclick="addEvent()">Add Event</button>
        <hr />
        <h4>Existing Events</h4>
        <div id="eventList"></div>
      </div>

      <!-- ================= ROUTINE EDITOR ================= -->
      <div class="card">
        <h3>üõ† Edit Routine</h3>

        <select id="editDay">
          <option value="MON">MON</option>
          <option value="TUE">TUE</option>
          <option value="WED">WED</option>
          <option value="THU">THU</option>
          <option value="FRI">FRI</option>
          <option value="SAT">SAT</option>
          <option value="SUN">SUN</option>
        </select>

        <select id="editTime"></select>

        <input id="editSubject" placeholder="Subject" />
        <input id="editRoom" placeholder="Room" />
        <input id="editCode" placeholder="Code" />

        <button class="btn-green" onclick="updateSlot()">Update Slot</button>
        <button class="btn-blue" onclick="addSlot()">Add Slot</button>
        <button class="btn-red" onclick="deleteSlot()">Delete Slot</button>
      </div>
      
      <hr />
      <h3>üìã Cancelled Classes List</h3>
      <div id="cancelList"></div>
    </div>

    <!-- ================= FIREBASE SCRIPT ================= -->
    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
      import {
        getFirestore,
        collection,
        addDoc,
        deleteDoc,
        getDocs,
        doc,
        getDoc,
        updateDoc,
        setDoc,
      } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-firestore.js";

      const firebaseConfig = {
        apiKey: "AIzaSyDoJVuE1cZTSRCMKen3DqlInJyZjQFs4UI",
        authDomain: "class-routine-8b46c.firebaseapp.com",
        projectId: "class-routine-8b46c",
        storageBucket: "class-routine-8b46c.firebasestorage.app",
        messagingSenderId: "666402119675",
        appId: "1:666402119675:web:8fdc82c87af8303ed1355e",
      };

      const app = initializeApp(firebaseConfig);
      const db = getFirestore(app);

      /* ================= TIME SLOT MANAGEMENT ================= */
      
      // Convert 24h time to 12h format
      function formatTime12h(time24) {
        const [h, m] = time24.split(':').map(Number);
        const period = h >= 12 ? 'PM' : 'AM';
        const h12 = h === 0 ? 12 : h > 12 ? h - 12 : h;
        return `${String(h12).padStart(2, '0')}:${String(m).padStart(2, '0')} ${period}`;
      }

      // Load and display current time slots
      async function loadCurrentTimeSlots() {
        const list = document.getElementById('currentSlotsList');
        list.innerHTML = '<div style="color: white;">Loading...</div>';

        try {
          const snap = await getDoc(doc(db, "settings", "timeSlots"));
          
          if (snap.exists()) {
            const slots = snap.data().slots || [];
            list.innerHTML = '';
            
            slots.forEach((slot, index) => {
              const div = document.createElement('div');
              div.style = 'background: rgba(255,255,255,0.1); padding: 8px; margin: 5px 0; border-radius: 6px; color: white;';
              div.innerHTML = `<b>Slot ${index + 1}:</b> ${slot}`;
              list.appendChild(div);
            });
          } else {
            list.innerHTML = '<div style="color: #fbbf24;">‚ö†Ô∏è No time slots configured. Set up default schedule below.</div>';
          }
        } catch (e) {
          list.innerHTML = '<div style="color: #ef4444;">‚ùå Error loading slots</div>';
          console.error(e);
        }
      }

      // Update a single time slot
      window.updateTimeSlot = async function() {
        const position = parseInt(slotPosition.value);
        const startTime = slotStartTime.value;
        const endTime = slotEndTime.value;

        if (!startTime || !endTime) {
          alert('‚ö†Ô∏è Please select both start and end times');
          return;
        }

        // Format to 12h
        const formatted = `${formatTime12h(startTime)} ‚Äì${formatTime12h(endTime)}`;

        try {
          // Get current slots
          const snap = await getDoc(doc(db, "settings", "timeSlots"));
          let slots = snap.exists() ? snap.data().slots : [];

          // Ensure array has enough slots
          while (slots.length <= position) {
            slots.push('');
          }

          // Update specific slot
          slots[position] = formatted;

          // Save back
          await setDoc(doc(db, "settings", "timeSlots"), { slots });

          alert(`‚úÖ Time Slot ${position + 1} updated to: ${formatted}`);
          loadCurrentTimeSlots();
          loadEditTimeDropdown();
          loadCancelSlots();
        } catch (e) {
          alert('‚ùå Error updating time slot');
          console.error(e);
        }
      };

      // Load normal schedule preset
      window.loadNormalSchedule = async function() {
        const slots = [
          "08:45 AM ‚Äì10:05 AM",
          "10:05 AM ‚Äì11:25 AM",
          "11:25 AM ‚Äì12:45 PM",
          "12:45 PM ‚Äì01:15 PM",
          "01:15 PM ‚Äì02:35 PM",
          "02:35 PM ‚Äì03:55 PM"
        ];

        if (!confirm('üîÑ This will replace all current time slots with normal schedule. Continue?')) {
          return;
        }

        try {
          await setDoc(doc(db, "settings", "timeSlots"), { slots });
          alert('‚úÖ Normal schedule loaded!');
          loadCurrentTimeSlots();
          loadEditTimeDropdown();
          loadCancelSlots();
        } catch (e) {
          alert('‚ùå Error loading preset');
          console.error(e);
        }
      };

      // Load Ramadan schedule preset
      window.loadRamadanSchedule = async function() {
        const slots = [
          "09:00 AM ‚Äì10:00 AM",
          "10:00 AM ‚Äì11:00 AM",
          "11:00 AM ‚Äì12:00 PM",
          "12:00 PM ‚Äì12:30 PM",
          "12:30 PM ‚Äì01:30 PM",
          "01:30 PM ‚Äì02:30 PM"
        ];

        if (!confirm('üåô This will replace all current time slots with Ramadan schedule. Continue?')) {
          return;
        }

        try {
          await setDoc(doc(db, "settings", "timeSlots"), { slots });
          alert('‚úÖ Ramadan schedule loaded!');
          loadCurrentTimeSlots();
          loadEditTimeDropdown();
          loadCancelSlots();
        } catch (e) {
          alert('‚ùå Error loading preset');
          console.error(e);
        }
      };

      // Load time slots into edit dropdown
      async function loadEditTimeDropdown() {
        const dropdown = document.getElementById('editTime');
        dropdown.innerHTML = '<option>Loading...</option>';

        try {
          const snap = await getDoc(doc(db, "settings", "timeSlots"));
          
          if (snap.exists()) {
            const slots = snap.data().slots || [];
            dropdown.innerHTML = '';
            
            slots.forEach(slot => {
              if (slot) {
                const opt = document.createElement('option');
                opt.value = slot;
                opt.textContent = slot;
                dropdown.appendChild(opt);
              }
            });
          } else {
            dropdown.innerHTML = '<option>No slots configured</option>';
          }
        } catch (e) {
          dropdown.innerHTML = '<option>Error loading slots</option>';
          console.error(e);
        }
      }

      /* ================= NOTICE FUNCTIONS ================= */
      window.addNotice = async function () {
        if (!title.value || !msg.value) {
          alert("‚ö†Ô∏è Please fill in title and message");
          return;
        }

        await addDoc(collection(db, "notices"), {
          title: title.value,
          message: msg.value,
          created: Date.now(),
        });

        alert("‚úÖ Notice saved");
        title.value = "";
        msg.value = "";
        loadNoticesList();
      };

      async function loadNoticesList() {
        const list = document.getElementById("noticeList");
        list.innerHTML = "";

        const snap = await getDocs(collection(db, "notices"));

        if (snap.empty) {
          list.innerHTML = "<p>No notices</p>";
          return;
        }

        snap.forEach((docSnap) => {
          const n = docSnap.data();

          const div = document.createElement("div");
          div.innerHTML = `
            <b>${n.title}</b>
            <button onclick="deleteNotice('${docSnap.id}')">‚ùå</button>
            <br>
            <small>${n.message}</small>
            <hr>
          `;

          list.appendChild(div);
        });
      }

      window.deleteNotice = async function (id) {
        await deleteDoc(doc(db, "notices", id));
        loadNoticesList();
      };

      /* ================= EVENT FUNCTIONS ================= */
      window.addEvent = async function () {
        if (!etype.value || !course.value || !etitle.value || !edate.value || !etime.value) {
          alert("‚ö†Ô∏è Please fill all fields");
          return;
        }

        await addDoc(collection(db, "events"), {
          type: etype.value.toLowerCase(),
          course: course.value,
          title: etitle.value,
          date: edate.value,
          time: etime.value,
        });

        alert("‚úÖ Event added");
        etype.value = "";
        course.value = "";
        etitle.value = "";
        edate.value = "";
        etime.value = "";
        loadEventList();
      };

      async function loadEventList() {
        const list = document.getElementById("eventList");
        list.innerHTML = "";

        const snap = await getDocs(collection(db, "events"));

        if (snap.empty) {
          list.innerHTML = "<p>No events</p>";
          return;
        }

        snap.forEach((docSnap) => {
          const e = docSnap.data();

          const div = document.createElement("div");
          div.innerHTML = `
            <b>${e.type.toUpperCase()}</b> - ${e.title}
            <button onclick="deleteEvent('${docSnap.id}')">‚ùå</button>
            <br>
            <small>${e.course} | ${e.date} ${e.time}</small>
            <hr>
          `;

          list.appendChild(div);
        });
      }

      window.deleteEvent = async function (id) {
        await deleteDoc(doc(db, "events", id));
        loadEventList();
      };

      /* ================= CANCEL CLASS TOGGLE ================= */
      async function findCancelDoc(day, time, date) {
        const snap = await getDocs(collection(db, "cancelled"));

        return snap.docs.find((d) => {
          const c = d.data();
          return c.day === day && c.time === time && c.date === date;
        });
      }

      window.toggleCancel = async function () {
        const day = cday.value;
        const time = ctime.value;
        const date = cdate.value;
        const reason = creason.value || "Cancelled";

        if (!date) {
          alert("‚ö†Ô∏è Please select a date");
          return;
        }

        const found = await findCancelDoc(day, time, date);

        if (found) {
          await deleteDoc(doc(db, "cancelled", found.id));
          alert("‚úÖ Cancel removed");
        } else {
          await addDoc(collection(db, "cancelled"), {
            day,
            time,
            date,
            reason,
          });
          alert("‚ùå Class cancelled");
        }

        updateToggleText();
        loadCancelledList();
      };

      async function updateToggleText() {
        const btn = document.getElementById("cancelToggleBtn");
        const date = cdate.value;

        if (!date) {
          btn.textContent = "Cancel Class";
          btn.className = "btn-red";
          return;
        }

        const found = await findCancelDoc(cday.value, ctime.value, date);

        if (found) {
          btn.textContent = "Undo Cancel";
          btn.className = "btn-green";
        } else {
          btn.textContent = "Cancel Class";
          btn.className = "btn-red";
        }
      }

      ["cday", "ctime", "cdate"].forEach((id) => {
        document.getElementById(id).addEventListener("change", updateToggleText);
      });

      /* ================= CANCELLED CLASSES LIST ================= */
      async function loadCancelledList() {
        const list = document.getElementById("cancelList");
        list.innerHTML = "";

        const snap = await getDocs(collection(db, "cancelled"));

        if (snap.empty) {
          list.innerHTML = "<p>No cancelled classes</p>";
          return;
        }

        snap.forEach((docSnap) => {
          const c = docSnap.data();

          const div = document.createElement("div");
          div.style = `
            background:#f1f5f9;
            padding:8px;
            margin:6px 0;
            border-radius:8px;
          `;

          div.innerHTML = `
            <b>${c.day}</b> |
            ${c.time} |
            ${c.date} |
            ${c.reason}

            <button onclick="deleteCancel('${docSnap.id}')" style="float:right;background:#dc2626;color:white;border:none;border-radius:6px;padding:4px 8px">
              ‚ùå Delete
            </button>
          `;

          list.appendChild(div);
        });
      }

      window.deleteCancel = async function (id) {
        await deleteDoc(doc(db, "cancelled", id));
        loadCancelledList();
      };

      /* ================= ROUTINE SLOT EDITOR ================= */
      document.getElementById("editTime").addEventListener("change", loadSlotDetails);
      document.getElementById("editDay").addEventListener("change", loadEditTimeDropdown);

      async function loadSlotDetails() {
        const day = editDay.value;

        const snap = await getDoc(doc(db, "routine", day));

        if (!snap.exists()) return;

        const classes = snap.data().classes;
        const found = classes.find((c) => c.time === editTime.value);

        if (!found) {
          editSubject.value = "";
          editRoom.value = "";
          editCode.value = "";
          return;
        }

        editSubject.value = found.subject;
        editRoom.value = found.room;
        editCode.value = found.code;
      }

      window.updateSlot = async function () {
        const day = editDay.value;

        const snap = await getDoc(doc(db, "routine", day));

        if (!snap.exists()) {
          alert("‚ùå Day not found");
          return;
        }

        const classes = snap.data().classes;
        const index = classes.findIndex((c) => c.time === editTime.value);

        if (index === -1) {
          alert("‚ùå Slot not found");
          return;
        }

        classes[index] = {
          time: editTime.value,
          subject: editSubject.value,
          room: editRoom.value,
          code: editCode.value,
        };

        await updateDoc(doc(db, "routine", day), {
          classes: classes,
        });

        alert("‚úÖ Slot updated");
      };

      window.addSlot = async function () {
        const day = editDay.value;

        const snap = await getDoc(doc(db, "routine", day));

        if (!snap.exists()) {
          alert("‚ùå Day not found");
          return;
        }

        const classes = snap.data().classes;

        if (classes.find((c) => c.time === editTime.value)) {
          alert("‚ùå Slot already exists");
          return;
        }

        classes.push({
          time: editTime.value,
          subject: editSubject.value,
          room: editRoom.value,
          code: editCode.value,
        });

        await updateDoc(doc(db, "routine", day), {
          classes: classes,
        });

        alert("‚úÖ Slot added");
      };

      window.deleteSlot = async function () {
        const day = editDay.value;

        const snap = await getDoc(doc(db, "routine", day));

        if (!snap.exists()) {
          alert("‚ùå Day not found");
          return;
        }

        let classes = snap.data().classes;
        classes = classes.filter((c) => c.time !== editTime.value);

        await updateDoc(doc(db, "routine", day), {
          classes: classes,
        });

        alert("üóë Slot removed");
      };

      /* ================= SMART CANCEL UI ================= */
      document.getElementById("cday").addEventListener("change", loadCancelSlots);

      async function loadCancelSlots() {
        const day = cday.value;

        const snap = await getDoc(doc(db, "routine", day));

        if (!snap.exists()) return;

        const classes = snap.data().classes;

        ctime.innerHTML = "";

        classes.forEach((c) => {
          const opt = document.createElement("option");
          opt.value = c.time;
          opt.textContent = c.time;
          ctime.appendChild(opt);
        });

        fillCancelSubject();
      }

      document.getElementById("ctime").addEventListener("change", fillCancelSubject);

      async function fillCancelSubject() {
        const day = cday.value;

        const snap = await getDoc(doc(db, "routine", day));

        if (!snap.exists()) return;

        const classes = snap.data().classes;
        const found = classes.find((c) => c.time === ctime.value);

        if (found) {
          csubject.value = found.subject + " (" + found.room + ")";
        }
      }

      /* ================= EFFECTIVE DATE MANAGER ================= */
      
      // Load current effective date
      async function loadCurrentEffectiveDate() {
        try {
          const snap = await getDoc(doc(db, "settings", "effectiveDate"));
          
          if (snap.exists()) {
            const dateStr = snap.data().date;
            document.getElementById("currentEffectiveDate").textContent = dateStr;
            
            // Pre-fill the input with current date
            const date = new Date(dateStr);
            const formattedDate = date.toISOString().split('T')[0];
            document.getElementById("effectiveDate").value = formattedDate;
          } else {
            document.getElementById("currentEffectiveDate").textContent = "7 FEBRUARY 2026 (Default)";
          }
        } catch (error) {
          console.error("Error loading effective date:", error);
          document.getElementById("currentEffectiveDate").textContent = "Error loading date";
        }
      }
      
      // Update effective date
      window.updateEffectiveDate = async function() {
        const dateInput = document.getElementById("effectiveDate").value;
        
        if (!dateInput) {
          alert("‚ùå Please select a date");
          return;
        }
        
        try {
          // Convert to readable format: "7 FEBRUARY 2026"
          const date = new Date(dateInput);
          const months = ['JANUARY', 'FEBRUARY', 'MARCH', 'APRIL', 'MAY', 'JUNE',
                         'JULY', 'AUGUST', 'SEPTEMBER', 'OCTOBER', 'NOVEMBER', 'DECEMBER'];
          
          const day = date.getDate();
          const month = months[date.getMonth()];
          const year = date.getFullYear();
          
          const formattedDate = `${day} ${month} ${year}`;
          
          // Save to Firebase
          await setDoc(doc(db, "settings", "effectiveDate"), {
            date: formattedDate,
            timestamp: new Date().toISOString()
          });
          
          alert(`‚úÖ Effective date updated to: ${formattedDate}`);
          loadCurrentEffectiveDate();
          
        } catch (error) {
          console.error("Error updating effective date:", error);
          alert("‚ùå Error updating date: " + error.message);
        }
      };

      // Load on page start
      loadCurrentTimeSlots();
      loadNoticesList();
      loadEventList();
      loadCancelledList();
      loadCancelSlots();
      loadEditTimeDropdown();
      loadCurrentEffectiveDate();
    </script>
  </body>
</html>
